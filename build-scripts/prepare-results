#!/bin/sh

# Prepare build artifacts and test results for collection/archival.
# This script collects built packages and test results from various locations
# and copies them to a single output directory ($OUTDIR) for easy retrieval.

# Source required configuration and utility files
. "$(dirname "$0")"/functions # $OUTDIR, $BASEDIR
. detect-environment          # $PACKAGING
. compile-options
. version

# Create output directory if it doesn't exist
mkdir -p "$OUTDIR"

# Collect built packages from each CFEngine edition directory
# Iterates through community, nova (enterprise agent), and nova-hub directories
for dir in cfengine-community cfengine-nova cfengine-nova-hub; do
    if [ -d "$BASEDIR"/$dir ]; then
        # Copy packages based on platform-specific packaging format
        case "$PACKAGING" in
        rpm)
            cp "$BASEDIR"/$dir/RPMS/*/*.rpm "$OUTDIR"
            cp "$BASEDIR"/$dir/RPMS/*.pkg.tar.gz "$OUTDIR"
            ;;
        deb)
            cp "$BASEDIR"/$dir/*.deb "$OUTDIR"
            cp "$BASEDIR"/$dir/pkg/*.pkg.tar.gz "$OUTDIR"
            ;;
        msi)
            cp "$BASEDIR"/$dir/*.msi "$OUTDIR"
            ;;
        solaris)
            cp "$BASEDIR"/$dir/*.pkg "$OUTDIR"
            ;;
        freebsd)
            cp build/$dir/pkg/*.tbz "$OUTDIR"
            ;;
        hpux)
            cp "$BASEDIR"/$dir/pkg/*.depot "$OUTDIR"
            ;;
        lpp)
            cp "$BASEDIR"/$dir/RPMS/*/*.rpm "$OUTDIR"
            cp "$HOME"/lppdir/out/*.bff "$OUTDIR"
            ;;
        *)
            echo "Unknown packaging system: $PACKAGING"
            exit 1
            ;;
        esac
        #cp $BASEDIR/$dir/*.generic-pkg.tar.gz "$OUTDIR"
    fi
done

# Collect test results from each tested project
# projects_to_test returns the list of projects that should be tested (defined in functions) based on $PROJECT (community/nova) and $ROLE (agent/hub)
for project in $(projects_to_test); do
    if [ -f "$BASEDIR"/"$project"/tests/acceptance/summary.log ]; then
        cp "$BASEDIR"/"$project"/tests/acceptance/summary.log "$OUTDIR"/"$project"-summary.log
        cp "$BASEDIR"/"$project"/tests/acceptance/test.log "$OUTDIR"/"$project"-test.log
        cp "$BASEDIR"/"$project"/tests/acceptance/test.xml "$OUTDIR"/"$project"-test.xml
    fi
done
